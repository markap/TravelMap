{% extends base_layout %}

{% block header_title %}
    {% trans %}Trip{% endtrans %}
{% endblock %}

{% block content %}

	<div class="row">
		<div class="col-md-6"><!-- Google map -->
			<div id="panel" class="col-lg-12 input-group">
      			<input id="target" type="text" placeholder="Location" class="form-control">
      			<span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
    		</div>
    		<div id="map-canvas"></div>
		</div>
		
		<div class="col-md-6">
			<!-- ID of the trip -->
			<input type="hidden" id="storyId" value="{{ story.id }}"/>
			<input type="hidden" id="dateTo" value="{{ story.dateto }}"/>
			<input type="hidden" id="dateFrom" value="{{ story.datefrom }}"/>
		
			<!-- Name of the trip -->
			<h3>{{ story.name }}</h3>
			
			<div class="btn-group">
				<button id="buttonEditStory" type="button" class="btn btn-default btn-xs">
					<span class="glyphicon glyphicon-pencil"></span> Edit
				</button>
				<button id="buttonDeleteStory" type="button" class="btn btn-default btn-xs">
					<span class="glyphicon glyphicon-remove"></span> Delete
				</button>
			</div>
			<br/><br/>

			<!-- Custom description -->
			<p>{{ story.desc }}</p>
			
			<hr /><!-- Informations about selection -->
			<h4 id="locName">Jagalchi Market</h4>
			
			<!-- Actions on location -->
			<div class="btn-group">
				<button id="buttonEditLocation" type="button" class="btn btn-default btn-xs">
					<span class="glyphicon glyphicon-pencil"></span> Edit
				</button>
				<button id="buttonDeleteLocation" type="button" class="btn btn-default btn-xs">
					<span class="glyphicon glyphicon-remove"></span> Delete
				</button>
			</div>
			<br/><br/>
		
			<!-- Custom description -->
			<p id="locDesc">The best fishmarket I've ever been to</p>
			<!-- Wikipedia description -->
			<p><img src="/img/wiki.png" alt="Wiki">
			<em><small>
			Jagalchi Fish Market is a fish market in the neighborhood of Nampo-dong in Jung-gu, and Chungmu-dong, Seo-gu, Busan, South Korea.[1] The market is located on the edge of Nampo Port, Busan. The name is said to have originated from jagal (gravel in Korean) because the market used to be surrounded by many gravels.[2] This is one of the ten landmarks of Busan, so many tourists visit there to shop.
			</small></em></p>
			
			<!-- Upload pictures -->
			<button id="buttonUploadPictures" type="button" class="btn btn-default btn-xs">
				<span class="glyphicon glyphicon-picture"></span> Upload pictures
			</button>
			<br/><br/>
			
			<!-- Related pictures -->
			<div class="row">
				<div class="col-sm-6 col-md-3">
					<a href="#" class="thumbnail">
						<img src="/img/sample1.jpg" alt="Sample 1">
					</a>
				</div>
				<div class="col-sm-6 col-md-3">
					<a href="#" class="thumbnail">
						<img src="/img/sample2.jpg" alt="Sample 2">
					</a>
				</div>
				<div class="col-sm-6 col-md-3">
					<a href="#" class="thumbnail">
						<img src="/img/sample3.jpg" alt="Sample 3">
					</a>
				</div>
			</div>
		</div>
	</div>
    
    <!-- Modal to create a new location -->
	{% include "modalCreateLocation.html" %}    
    
    <!-- Modal to edit a location -->
    {% include "modalEditLocation.html" %}
    
    <!-- Modal to edit the story -->
    {% include "modalEditStory.html" %}
    
{% endblock %}

{% block mediaJS %}
    
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script>
    	// Open modal to create a new location
		function openModal() {
			$('#modalCreateLocation').modal('show');
		}
    
		function initialize() {
			$.ajax
			// Add new pictures
    		$('#buttonMore').click(function(){
    			$('#picturesUpload').append('<div class="form-group"><label for="inputFile" class="col-lg-2 control-label"></label><div class="col-lg-10"><input type="file" id="inputFile"><p class="help-block"></p></div></div>');
    		});

			// Edit story
			$('#buttonEditStory').click(function() {
				var datefrom = $('#dateFrom').val();
				var dateto = $('#dateTo').val();
				//TODO format is yyyy-mm-dd
				$('#dateBeginStory').datepicker('setValue', '07/10/2013');
				$('#dateEndStory').datepicker('setValue', '10/10/2013');

				$('#modalEditStory').modal('show');
			});

			
			
			// Edit location
			$('#buttonEditLocation').click(function() {
			
			});
			
			// Delete location
			$('#buttonDeleteLocation').click(function() {
			
			});
			
  			var map = new google.maps.Map(document.getElementById('map-canvas'), {
    			mapTypeId: google.maps.MapTypeId.ROADMAP,
    			zoom: 7
  			});
  			
  			var defaultBounds = new google.maps.LatLngBounds(
      			new google.maps.LatLng(35.129554, 129.015642),
      			new google.maps.LatLng(35.209554, 129.105642));
  			map.fitBounds(defaultBounds);

  			var input = /** @type {HTMLInputElement} */(document.getElementById('target'));
  			console.log(input);
  			var searchBox = new google.maps.places.SearchBox(input);
  			var markers = [];

			// Create a marker after a research
  			google.maps.event.addListener(searchBox, 'places_changed', function() {
	    		var places = searchBox.getPlaces();
	
	    		for (var i = 0, marker; marker = markers[i]; i++) {
	      			marker.setMap(null);
	    		}
	    		
	    		markers = [];
	    		var bounds = new google.maps.LatLngBounds();
	    		for (var i = 0, place; place = places[i]; i++) {
	      			var image = {
	        			url: place.icon,
	        			size: new google.maps.Size(71, 71),
	        			origin: new google.maps.Point(0, 0),
	        			anchor: new google.maps.Point(17, 34),
	        			scaledSize: new google.maps.Size(25, 25)
	      			};
	
	      			var marker = new google.maps.Marker({
	        			map: map,
	        			icon: image,
	        			title: place.name,
	        			position: place.geometry.location
	      			});
	      			
	      			var infowindow = new google.maps.InfoWindow({
	      				content: "Button"
	  				});
	      			
	      			google.maps.event.addListener(marker, 'click', function() {
	    				infowindow.open(map,marker);
	  				});
	
	      			markers.push(marker);
	
	      			bounds.extend(place.geometry.location);
	    		}
	
	    		map.fitBounds(bounds);
  		});
	
  		google.maps.event.addListener(map, 'bounds_changed', function() {
    		var bounds = map.getBounds();
    		searchBox.setBounds(bounds);
  		});
  		
		$.ajax({
  				type: "POST",
  				url: '/story.detail/' + {{ story.id }},
  				success: updateMarkers
		});
		
		var global_locations;
		
		function get_location_for_index(idx) {
			for (var i = 0; i < global_locations.length; i++) {
				loc = global_locations[i];
				if (loc.locationindex == idx) {
					return loc;
				}
			} 
		}
		
		function updateMarkers(data) {
			global_locations = data.record.locations;
			for (var i = 0; i < global_locations.length; i++) {
				loc = global_locations[i];
			
				var marker = new google.maps.Marker({
       				map: map,
       				locationindex: loc.locationindex,
        			icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
        			position: new google.maps.LatLng(loc.latitude, loc.longitude),
      			});
      			
      			google.maps.event.addListener(marker, 'click', (function(m) {
      				return function() {
      				    loc = get_location_for_index(m.locationindex);
      				    
      				    if (loc != null) {
      				    	      				    	
      				    	$('#locName').text(loc.name);
      				    	$('#locDesc').text(loc.desc);
      				    	
      				    }
      				};
				})(marker)); 
			}
		}
		
		var clickMarker;

		function placeMarker(location) {
    		clickMarker = new google.maps.Marker({
      			position: location,
      			info: new google.maps.InfoWindow({
      				content: "New Location <br/> <button type='button' class='btn btn-primary btn-xs' onClick='openModal();'>Create</button>"
  				}),
      			
      			map: map
    		});
    		clickMarker.info.open(map, clickMarker);
		}
		
		var latestPosition;
		google.maps.event.addListener(map, 'click', function(event) {
			latestPosition = {'latitude': event.latLng.lat(),
							   'longitude': event.latLng.lng()
							   };
  			placeMarker(event.latLng);
		});
		
		// --- Create a new location --- //
		$('#addLocation').click(function() {
			var locName = $('#locationInputName').val();
			if(locName) {
				$('#modalCreateLocation').modal('hide');
			
				data = {'name': $('#locationInputName').val(),
						'desc': $('#locationInputDesc').val(),
						'latitude': latestPosition.latitude,
						'longitude': latestPosition.longitude
						};
				
				$.ajax({
	  				type: "POST",
	  				url: '/story.addlocation/' + {{ story.id }},
	  				data: data
				}).done(function(data){
					updateMarkers(data);
				});			
			} else {
				// TODO : error message in the modal
			}
		});
	}

	google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    
{% endblock %}