{% extends base_layout %}

<!-- 
{% block extrahead %}
	<script src="story.js"></script>
{% endblock %}
 -->

{% block header_title %}
    {% trans %}Stories{% endtrans %}
{% endblock %}

{% block content %}
    <button id="buttonCreate" type="button" class="btn btn-primary">Create a new trip</button>
    <br/><br/>
    
    <!-- List of the stories -->
    <table class="table table-hover">
	    <tbody>
			{% for story in stories %}
			    <tr>
			  		<td>{{ story.name }}</td>
			  		<td>
			  			<a href="/trip/{{ story.id }}">View story</a>
			  		</td>
			  	</tr>
			{% endfor %}
    	</tbody>
    </table>
    
    <!-- Modal to create a new story -->
    <div id="modalCreate" class="modal fade">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h4 class="modal-title">New trip story</h4>
	      </div>
	      <div class="modal-body">
	        <form class="form-horizontal" role="form">
	        	<div id="modalError"></div>
				<!-- Name -->
		        <div class="form-group">
					<label for="inputName" class="col-lg-2 control-label">Name</label>
					<div class="col-lg-10">
			    		<input class="form-control" type="text" id="inputName" placeholder="Name of your trip">
					</div>
				</div>
			  
				<!-- Dates of the trip -->
			  	<div class="form-group">
			  		<label for="dateBegin" class="col-lg-2 control-label">From</label>
			  		<div class="col-lg-10">
			  			<input id="dateBegin" class="form-control datepicker" type="text" />
			  		</div>
			  	</div>
			  	<div class="form-group">
			  		<label for="dateEnd" class="col-lg-2 control-label">To</label>
			  		<div class="col-lg-10">
				  		<input id="dateEnd" class="form-control datepicker" type="text"/>
					</div>
			  	</div>
			  
			    <!-- Description -->
		        <div class="form-group">
				    <label for="inputDesc" class="col-lg-2 control-label">Description</label>
				    <div class="col-lg-10">
				    	<textarea class="form-control" type="text" id="inputDesc" rows="3" placeholder="A few words about the trip..."></textarea>
				    </div>
			    </div>
	        </form>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" id="buttonCancel" data-dismiss="modal">Cancel</button>
	        <button type="button" class="btn btn-primary" id="createStory">Create</button>
	      </div>
	    </div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	
{% endblock %}

{% block mediaJS %}
    <script>
    $().ready(function() {
		$('#buttonCreate').click(function() {
			$('#modalCreate').modal('show');
		});
		
		$('#buttonCancel').click(function(){
			// Clean the modal
			$('#inputName').val('');
			$('#inputDesc').val('');
			// FIX ME
			//$('#dataBegin').datepicker('setValue', '');
			//$('#dataEnd').datepicker('setValue', '');
		});
		
		$('#createStory').click(function() {
			var name = $('#inputName').val();
			if(name) {
				$.ajax({
	  				type: "POST",
	  				url: '/story.register/',
	  				data: {'name': $('#inputName').val(),
	  						'datefrom': $('#dateBegin').val(),
	  						'dateto': $('#dateEnd').val(),
	  						'desc': $('#inputDesc').val()}
				})
				.done(function(data) {
					if(data.status == 'OK'){
						// Close the modal
						$('#modalCreate').modal('hide');
						// Redirect to trip page
						var url = "/trip/" + data.record.storykey;
						window.location.replace(url);
					} else {
						// Server error
						$('#modalError').html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Sorry!</strong> An internal error occured, please try again</div>');
					}
				});
			} else {
				$('#modalError').html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Error!</strong> The name of the trip is mandatory</div>');
			}
		});
		
		// Date picker
		var nowTemp = new Date();
		var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
		
		var dateBegin = $('#dateBegin').datepicker({
			format : 'dd/mm/yyyy',
			weekStart : 1
		})
		.on('changeDate', function(ev) {
	  		if (ev.date.valueOf() > dateEnd.date.valueOf()) {
	    		var newDate = new Date(ev.date)
	    		newDate.setDate(newDate.getDate() + 1);
	    		dateEnd.setValue(newDate);
			}
			dateBegin.hide();
			$('#dateEnd').focus();
		}).data('datepicker');
		
		var dateEnd = $('#dateEnd').datepicker({
			format: 'dd/mm/yyyy',
			weekStart : 1,
		  onRender: function(date) {
		    return date.valueOf() <= dateBegin.date.valueOf() ? 'disabled' : '';
		  }
		}).on('changeDate', function(ev) {
		  dateEnd.hide();
		}).data('datepicker');

	});
	</script>
{% endblock %}