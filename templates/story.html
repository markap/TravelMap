{% extends base_layout %}

<!-- 
{% block extrahead %}
	<script src="story.js"></script>
{% endblock %}
 -->

{% block header_title %}
    {% trans %}Stories{% endtrans %}
{% endblock %}

{% block content %}
    <div class="panel panel-default">
		<!-- Default panel contents -->
		<div class="panel-body">
			<button id="buttonCreate" type="button" class="btn btn-primary">
	 		   <span class="glyphicon glyphicon-plus"></span> Create a new trip
	   		</button>
		</div>
		<!-- List of the stories -->
	    <table class="table table-hover">
		    <tbody>
				{% for story in stories %}
				    <tr id="{{story.id}}" class="story">
				  		<td>{{ story.name }}</td>
				  		<td>
				  			<a href="/trip/{{ story.id }}" class="btn btn-default btn-small">
					  			<span class="glyphicon glyphicon-map-marker"></span> View story
				  			</a>
				  		</td>
				  		<td>
				  			<button class="btn btn-default btn-small">
				  				<span class="glyphicon glyphicon-pencil"></span> Edit story
				  			</button>
				  		</td>
				  		<td>
				  			<button class="btn btn-default btn-small" onClick="openDeleteModal({{story.id}});">
				  			<span class="glyphicon glyphicon-remove"></span> Delete story
				  			</button>
				  		</td>
				  	</tr>
				{% endfor %}
	    	</tbody>
	    </table>
	</div>
    
    {% include "modalCreateStory.html" %}
    {% include "modalDeleteStory.html" %}
	
{% endblock %}

{% block mediaJS %}
    <script>
    function openDeleteModal(idStory) {
    	$('#modalDelete').modal('show');
    	$('#idStoryDelete').val(idStory);
   	}
    
    $().ready(function() {
		// ----- Create a story ----- //    
		$('#buttonCreate').click(function() {
			$('#modalCreate').modal('show');
		});
		
		$('#buttonCancel').click(function(){
			// Clean the modal
			$('#inputName').val('');
			$('#inputDesc').val('');
			// FIX ME
			//$('#dataBegin').datepicker('setValue', '');
			//$('#dataEnd').datepicker('setValue', '');
		});
		
		$('#createStory').click(function() {
			var name = $('#inputName').val();
			if(name) {
				$.ajax({
	  				type: "POST",
	  				url: '/story.register/',
	  				data: {'name': $('#inputName').val(),
	  						'datefrom': $('#dateBegin').val(),
	  						'dateto': $('#dateEnd').val(),
	  						'desc': $('#inputDesc').val()}
				})
				.done(function(data) {
					if(data.status == 'OK'){
						// Close the modal
						$('#modalCreate').modal('hide');
						// Redirect to trip page
						var url = "/trip/" + data.record.storykey;
						window.location.replace(url);
					} else {
						// Server error
						$('#modalError').html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Sorry!</strong> An internal error occured, please try again</div>');
					}
				});
			} else {
				$('#modalError').html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Error!</strong> The name of the trip is mandatory</div>');
			}
		});

		// Date picker
		var nowTemp = new Date();
		var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);
		
		var dateBegin = $('#dateBegin').datepicker({
			format : 'dd/mm/yyyy',
			weekStart : 1
		})
		.on('changeDate', function(ev) {
	  		if (ev.date.valueOf() > dateEnd.date.valueOf()) {
	    		var newDate = new Date(ev.date)
	    		newDate.setDate(newDate.getDate() + 1);
	    		dateEnd.setValue(newDate);
			}
			dateBegin.hide();
			$('#dateEnd').focus();
		}).data('datepicker');
		
		var dateEnd = $('#dateEnd').datepicker({
			format: 'dd/mm/yyyy',
			weekStart : 1,
		  onRender: function(date) {
		    return date.valueOf() <= dateBegin.date.valueOf() ? 'disabled' : '';
		  }
		}).on('changeDate', function(ev) {
		  dateEnd.hide();
		}).data('datepicker');

		// ----- Delete a story ----- //
		$('#deleteStory').click(function(){
			var idStory = $('#idStoryDelete').val();
			$('#modalDelete').modal('hide');
			if(idStory) {
		  		$.ajax({
					type: "POST",
					url: '/story.delete/'+idStory
					//data: {'storyid': idStory}
				})
				.done(function(data){
					if(data.status == "OK") {
						// Erase the trip from the list
						$('#'+idStory).remove();
					}
				});
			}
		});
	});
	</script>
{% endblock %}